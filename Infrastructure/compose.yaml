name: cloud-native-microservices

services:
  # Nginx proxy - port 80
  proxy:
    image: nginx:alpine
    container_name: budibase-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - budibase
      - jsonserver
      - couchdb
    networks:
      - budibase_network

  # Βάση δεδομένων CouchDB
  couchdb:
    image: budibase/couchdb:latest
    container_name: budibase-couchdb
    restart: unless-stopped
    environment:
      COUCHDB_USER: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
    ports:
      - "5984:5984"
    volumes:
      - ../Persistent Storage/budibase_storage/couch:/data/couch
    networks:
      - budibase_network

  # Redis για caching
  redis:
    image: redis:7-alpine
    container_name: budibase-redis
    restart: unless-stopped
    volumes:
      - ../Persistent Storage/redis_storage:/data
    networks:
      - budibase_network

  # Budibase - Κύρια εφαρμογή
  budibase:
    image: budibase/budibase:latest
    container_name: budibase
    restart: unless-stopped

    environment:
      # Connection strings για βάση και redis
      BB_COUCHDB_URL: http://${COUCHDB_USER}:${COUCHDB_PASSWORD}@budibase-couchdb:5984
      BB_REDIS_URL: redis://budibase-redis:6379
      REDIS_URL: redis://budibase-redis:6379
      REDIS_MODE: remote
    depends_on:
      - couchdb
      - redis
    volumes:
      - ../Persistent Storage/budibase_storage:/data
    networks:
      - budibase_network

  # Custom API από το φάκελο mock-api
  jsonserver:
    build:
      context: ../Data Context/mock-api
      dockerfile: Dockerfile
    container_name: jsonserver

    volumes:
      - ../Data Context/mock-api/db.json:/app/db.json
    networks:
      - budibase_network

  # Portainer για έλεγχο των containers
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../Persistent Storage/portainer_storage:/data
    networks:
      - budibase_network

  # 2ο Mock API - JSON Server
  jsonplaceholder:
    image: clue/json-server
    container_name: json-placeholder-api
    restart: unless-stopped

    volumes:
      - ../Data Context/mock-api-2/db.json:/data/db.json
    command: /data/db.json
    networks:
      - budibase_network

# Δίκτυο microservices
networks:
  budibase_network:
    driver: bridge
